import datetime
import subprocess
from types import FrameType
from typing import Optional
import sys
import time

import utility_pydate
from config import LOG_LEVEL_TO_SEE


class Utilities:

    @staticmethod
    def delay_to_not_bog_cpu() -> None:
        time.sleep(0.001)

    @staticmethod
    def print_with_indent(msg: str) -> None:
        Utilities.print_with_indent_and_log_level(msg, 3, caller_is_n_up_the_stack=1)

    @staticmethod
    def print_with_indent_and_log_level(msg: str, log_level: int, caller_is_n_up_the_stack: int = 0) -> None:

        if log_level < LOG_LEVEL_TO_SEE:
            return

        caller_frame: Optional[FrameType] = sys._getframe(1 + caller_is_n_up_the_stack)  # 1 = caller
        caller_name = caller_frame.f_code.co_name if caller_frame else "<unknown>"

        depth = 0
        frame: Optional[FrameType] = caller_frame
        while frame:
            depth += 1
            frame = frame.f_back  # mypy is happy because frame is Optional[FrameType]

        indent = "    " * (depth - 1)
        extra_indent = " " * (len(msg) - len(msg.lstrip(' ')))
        print(f"{indent}{extra_indent}[{datetime.datetime.now()}][{caller_name}] {msg.lstrip(' ')}")

    @staticmethod
    def trim_trailing_empty(lines: list[str]) -> list[str]:
        while lines and lines[-1].strip() == "":
            lines.pop()
        return lines

    @staticmethod
    def print_lines(old_lines, lines_to_print,
                    message: str = "self.lines(old) vs lines_to_print (new)"):

        if old_lines is None:
            old_lines = []

        if lines_to_print is None:
            lines_to_print = []

        Utilities.print_with_indent(f"{message}")
        max_length_string = 0
        for i in range(max(len(old_lines), len(lines_to_print))):
            if i <= len(lines_to_print) - 1:
                max_length_string = max(max_length_string, len(lines_to_print[i]))

            if i <= len(old_lines) - 1:
                max_length_string = max(max_length_string, len(old_lines[i]))

        for i in range(max(len(old_lines), len(lines_to_print))):
            new = "--no record--"
            old = "--no record--"
            if i <= len(lines_to_print) - 1:
                if lines_to_print[i].strip() == "":
                    new = "--empty line--"
                else:
                    new = lines_to_print[i]

            if i <= len(old_lines) - 1:
                if old_lines[i].strip() == "":
                    old = "--empty line--"
                else:
                    old = old_lines[i]

            Utilities.print_with_indent_and_log_level(
                f"  '{old.ljust(max_length_string)}'  -  '{new.ljust(max_length_string)}'", 3)

    # prints the "font" used by the smartxe library
    @staticmethod
    def print_font_char(char_bytes):
        """
        Print an 8x8 character bitmap to console.
        char_bytes: list of 8 bytes, each representing a column
        """
        # Since each byte is a column, we need to transpose to print rows
        for row in range(8):
            line = ""
            for col in range(8):
                # Check if bit 'row' is set in byte 'col'
                if char_bytes[col] & (1 << row):
                    line += "██"  # Filled pixel
                else:
                    line += "  "  # Empty pixel
            print(line)

    # font data from the smart library
    uc_font = [0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x06, 0x5f, 0x5f, 0x06, 0x00, 0x00,
               0x00, 0x07, 0x07, 0x00, 0x07, 0x07, 0x00, 0x00, 0x14, 0x7f, 0x7f, 0x14, 0x7f, 0x7f, 0x14, 0x00,
               0x24, 0x2e, 0x2a, 0x6b, 0x6b, 0x3a, 0x12, 0x00, 0x46, 0x66, 0x30, 0x18, 0x0c, 0x66, 0x62, 0x00,
               0x30, 0x7a, 0x4f, 0x5d, 0x37, 0x7a, 0x48, 0x00, 0x00, 0x04, 0x07, 0x03, 0x00, 0x00, 0x00, 0x00,
               0x00, 0x1c, 0x3e, 0x63, 0x41, 0x00, 0x00, 0x00, 0x00, 0x41, 0x63, 0x3e, 0x1c, 0x00, 0x00, 0x00,
               0x08, 0x2a, 0x3e, 0x1c, 0x1c, 0x3e, 0x2a, 0x08, 0x00, 0x08, 0x08, 0x3e, 0x3e, 0x08, 0x08, 0x00,
               0x00, 0x00, 0x80, 0xe0, 0x60, 0x00, 0x00, 0x00, 0x00, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x00,
               0x00, 0x00, 0x00, 0x60, 0x60, 0x00, 0x00, 0x00, 0x60, 0x30, 0x18, 0x0c, 0x06, 0x03, 0x01, 0x00,
               0x3e, 0x7f, 0x59, 0x4d, 0x47, 0x7f, 0x3e, 0x00, 0x40, 0x42, 0x7f, 0x7f, 0x40, 0x40, 0x00, 0x00,
               0x62, 0x73, 0x59, 0x49, 0x6f, 0x66, 0x00, 0x00, 0x22, 0x63, 0x49, 0x49, 0x7f, 0x36, 0x00, 0x00,
               0x18, 0x1c, 0x16, 0x53, 0x7f, 0x7f, 0x50, 0x00, 0x27, 0x67, 0x45, 0x45, 0x7d, 0x39, 0x00, 0x00,
               0x3c, 0x7e, 0x4b, 0x49, 0x79, 0x30, 0x00, 0x00, 0x03, 0x03, 0x71, 0x79, 0x0f, 0x07, 0x00, 0x00,
               0x36, 0x7f, 0x49, 0x49, 0x7f, 0x36, 0x00, 0x00, 0x06, 0x4f, 0x49, 0x69, 0x3f, 0x1e, 0x00, 0x00,
               0x00, 0x00, 0x00, 0x66, 0x66, 0x00, 0x00, 0x00, 0x00, 0x00, 0x80, 0xe6, 0x66, 0x00, 0x00, 0x00,
               0x08, 0x1c, 0x36, 0x63, 0x41, 0x00, 0x00, 0x00, 0x00, 0x14, 0x14, 0x14, 0x14, 0x14, 0x14, 0x00,
               0x00, 0x41, 0x63, 0x36, 0x1c, 0x08, 0x00, 0x00, 0x00, 0x02, 0x03, 0x59, 0x5d, 0x07, 0x02, 0x00,
               0x3e, 0x7f, 0x41, 0x5d, 0x5d, 0x5f, 0x0e, 0x00, 0x7c, 0x7e, 0x13, 0x13, 0x7e, 0x7c, 0x00, 0x00,
               0x41, 0x7f, 0x7f, 0x49, 0x49, 0x7f, 0x36, 0x00, 0x1c, 0x3e, 0x63, 0x41, 0x41, 0x63, 0x22, 0x00,
               0x41, 0x7f, 0x7f, 0x41, 0x63, 0x3e, 0x1c, 0x00, 0x41, 0x7f, 0x7f, 0x49, 0x5d, 0x41, 0x63, 0x00,
               0x41, 0x7f, 0x7f, 0x49, 0x1d, 0x01, 0x03, 0x00, 0x1c, 0x3e, 0x63, 0x41, 0x51, 0x33, 0x72, 0x00,
               0x7f, 0x7f, 0x08, 0x08, 0x7f, 0x7f, 0x00, 0x00, 0x00, 0x41, 0x7f, 0x7f, 0x41, 0x00, 0x00, 0x00,
               0x30, 0x70, 0x40, 0x41, 0x7f, 0x3f, 0x01, 0x00, 0x41, 0x7f, 0x7f, 0x08, 0x1c, 0x77, 0x63, 0x00,
               0x41, 0x7f, 0x7f, 0x41, 0x40, 0x60, 0x70, 0x00, 0x7f, 0x7f, 0x0e, 0x1c, 0x0e, 0x7f, 0x7f, 0x00,
               0x7f, 0x7f, 0x06, 0x0c, 0x18, 0x7f, 0x7f, 0x00, 0x1c, 0x3e, 0x63, 0x41, 0x63, 0x3e, 0x1c, 0x00,
               0x41, 0x7f, 0x7f, 0x49, 0x09, 0x0f, 0x06, 0x00, 0x1e, 0x3f, 0x21, 0x31, 0x61, 0x7f, 0x5e, 0x00,
               0x41, 0x7f, 0x7f, 0x09, 0x19, 0x7f, 0x66, 0x00, 0x26, 0x6f, 0x4d, 0x49, 0x59, 0x73, 0x32, 0x00,
               0x03, 0x41, 0x7f, 0x7f, 0x41, 0x03, 0x00, 0x00, 0x7f, 0x7f, 0x40, 0x40, 0x7f, 0x7f, 0x00, 0x00,
               0x1f, 0x3f, 0x60, 0x60, 0x3f, 0x1f, 0x00, 0x00, 0x3f, 0x7f, 0x60, 0x30, 0x60, 0x7f, 0x3f, 0x00,
               0x63, 0x77, 0x1c, 0x08, 0x1c, 0x77, 0x63, 0x00, 0x07, 0x4f, 0x78, 0x78, 0x4f, 0x07, 0x00, 0x00,
               0x47, 0x63, 0x71, 0x59, 0x4d, 0x67, 0x73, 0x00, 0x00, 0x7f, 0x7f, 0x41, 0x41, 0x00, 0x00, 0x00,
               0x01, 0x03, 0x06, 0x0c, 0x18, 0x30, 0x60, 0x00, 0x00, 0x41, 0x41, 0x7f, 0x7f, 0x00, 0x00, 0x00,
               0x08, 0x0c, 0x06, 0x03, 0x06, 0x0c, 0x08, 0x00, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80, 0x80,
               0x00, 0x00, 0x03, 0x07, 0x04, 0x00, 0x00, 0x00, 0x20, 0x74, 0x54, 0x54, 0x3c, 0x78, 0x40, 0x00,
               0x41, 0x7f, 0x3f, 0x48, 0x48, 0x78, 0x30, 0x00, 0x38, 0x7c, 0x44, 0x44, 0x6c, 0x28, 0x00, 0x00,
               0x30, 0x78, 0x48, 0x49, 0x3f, 0x7f, 0x40, 0x00, 0x38, 0x7c, 0x54, 0x54, 0x5c, 0x18, 0x00, 0x00,
               0x48, 0x7e, 0x7f, 0x49, 0x03, 0x06, 0x00, 0x00, 0x98, 0xbc, 0xa4, 0xa4, 0xf8, 0x7c, 0x04, 0x00,
               0x41, 0x7f, 0x7f, 0x08, 0x04, 0x7c, 0x78, 0x00, 0x00, 0x44, 0x7d, 0x7d, 0x40, 0x00, 0x00, 0x00,
               0x60, 0xe0, 0x80, 0x84, 0xfd, 0x7d, 0x00, 0x00, 0x41, 0x7f, 0x7f, 0x10, 0x38, 0x6c, 0x44, 0x00,
               0x00, 0x41, 0x7f, 0x7f, 0x40, 0x00, 0x00, 0x00, 0x7c, 0x7c, 0x18, 0x78, 0x1c, 0x7c, 0x78, 0x00,
               0x7c, 0x78, 0x04, 0x04, 0x7c, 0x78, 0x00, 0x00, 0x38, 0x7c, 0x44, 0x44, 0x7c, 0x38, 0x00, 0x00,
               0x84, 0xfc, 0xf8, 0xa4, 0x24, 0x3c, 0x18, 0x00, 0x18, 0x3c, 0x24, 0xa4, 0xf8, 0xfc, 0x84, 0x00,
               0x44, 0x7c, 0x78, 0x4c, 0x04, 0x0c, 0x18, 0x00, 0x48, 0x5c, 0x54, 0x74, 0x64, 0x24, 0x00, 0x00,
               0x04, 0x04, 0x3e, 0x7f, 0x44, 0x24, 0x00, 0x00, 0x3c, 0x7c, 0x40, 0x40, 0x3c, 0x7c, 0x40, 0x00,
               0x1c, 0x3c, 0x60, 0x60, 0x3c, 0x1c, 0x00, 0x00, 0x3c, 0x7c, 0x60, 0x30, 0x60, 0x7c, 0x3c, 0x00,
               0x44, 0x6c, 0x38, 0x10, 0x38, 0x6c, 0x44, 0x00, 0x9c, 0xbc, 0xa0, 0xa0, 0xfc, 0x7c, 0x00, 0x00,
               0x4c, 0x64, 0x74, 0x5c, 0x4c, 0x64, 0x00, 0x00, 0x08, 0x08, 0x3e, 0x77, 0x41, 0x41, 0x00, 0x00,
               0x00, 0x00, 0x00, 0x77, 0x77, 0x00, 0x00, 0x00, 0x41, 0x41, 0x77, 0x3e, 0x08, 0x08, 0x00, 0x00,
               0x02, 0x03, 0x01, 0x03, 0x02, 0x03, 0x01, 0x00, 0x70, 0x78, 0x4c, 0x46, 0x4c, 0x78, 0x70, 0x00]

    # To print all characters from ucFont array:
    @staticmethod
    def print_all_font_chars(ucFont):
        """
        Print all characters from the font array.
        ucFont: byte array where each character is 8 bytes
        """
        for char_code in range(32, 128):  # Printable ASCII
            char_index = (char_code - 32) * 8
            char_bytes = ucFont[char_index:char_index + 8]

            print(f"\n'{chr(char_code)}' (ASCII {char_code}):")
            Utilities.print_font_char(char_bytes)
            print("-" * 20)

    @staticmethod
    def execute_internal_command(command: str) -> list[str]:
        if command == "pd":
            return utility_pydate.Utility_pydate.get_pydate()

        return []

    @staticmethod
    def is_internal_command(command: str) -> bool:
        if command == "pd":
            return True

        return False

    @staticmethod
    def apply_user_substitutions(cmd: str) -> str:
        if cmd == "cal":
            return "ncal -bwh"

        return cmd
